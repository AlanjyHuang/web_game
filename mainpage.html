<!DOCTYPE html>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<!-- 
source: https://gist.github.com/tanmaykm/5111225 
-->
<html>
    <head>
        <title>Websocket Demo</title>
        <style>
            .cell {
                border: dotted 1px #444444;
                font: 40px arial, sans-serif;
            }
        </style>
        <script>
            function log_msg(msg) {
                console.log(msg)
            }
            var owner
            var s //socket object for connection
            function doInit() {
                try {
                    owner = document.getElementById('user').value
                    var host = 'ws://localhost:4545/' //設定socker server的ip:port
                    /*if(window.location.hostname) {
                      		host = "ws://" + window.location.hostname + ":4545/";
                      	}*/

                    s = new WebSocket(host) //建立socket元件
                    //設定幾個主要事件
                    s.onopen = function (e) {
                        log_msg('connected...')
                    }
                    s.onclose = function (e) {
                        log_msg('connection closed.')
                    }
                    s.onerror = function (e) {
                        log_msg('connection error.')
                    }

                    //當server送訊息來時
                    s.onmessage = function (e) {
                        log_msg('message: ' + e.data)
                        //e.data是Socket server送來的訊息
                        //用, 來切割訊息
                        strs = e.data.split(',')
                        //解讀各段訊息的內容
                        cellID = strs[0] //格子的ID
                        cellOwner = strs[1] //使用的符號
                        setCell(cellID, cellOwner) //改格子的符號
                    }
                } catch (ex) {
                    log_msg('connection exception:' + ex)
                }

                //取得class是 "cell" 的元件
                const cells = document.querySelectorAll('.cell')
                //逐一設定onclick事件
                cells.forEach(function (el) {
                    el.onclick = function () {
                        id = this.id
                        //   console.log(id)

                        //若格子尚未被選
                        //取得使用的符號
                        //let user = document.getElementById('user').value
                        //把格子id跟使用的符號傳給socket server
                        s.send(id + ',' + owner)
                    }
                })
            }

            //設定格子的符號
            function setCell(id, owner) {
                now = parseInt(document.getElementById(id).innerText)
                log_msg(now)
                if (owner == owner) {
                    document.getElementById(id).innerHTML = now + 1
                } else document.getElementById(id).innerHTML = now - 1
            }
        </script>
    </head>
    <body onload="doInit()">
        <h3>搶地遊戲</h3>
        <br />
        輸入使用者名稱<input type="text" value="O" id="user" />
        <table border="1" width="500px" height="500px">
            <tr>
                <td class="cell" id="00">0</td>
                <td class="cell" id="10">0</td>
                <td class="cell" id="20">0</td>
                <td class="cell" id="30">0</td>
                <td class="cell" id="40">0</td>
            </tr>
            <tr>
                <td class="cell" id="01">0</td>
                <td class="cell" id="11">0</td>
                <td class="cell" id="21">0</td>
                <td class="cell" id="31">0</td>
                <td class="cell" id="41">0</td>
            </tr>
            <tr>
                <td class="cell" id="02">0</td>
                <td class="cell" id="12">0</td>
                <td class="cell" id="22">0</td>
                <td class="cell" id="32">0</td>
                <td class="cell" id="42">0</td>
            </tr>
            <tr>
                <td class="cell" id="03">0</td>
                <td class="cell" id="13">0</td>
                <td class="cell" id="23">0</td>
                <td class="cell" id="33">0</td>
                <td class="cell" id="43">0</td>
            </tr>
            <tr>
                <td class="cell" id="04">0</td>
                <td class="cell" id="14">0</td>
                <td class="cell" id="24">0</td>
                <td class="cell" id="34">0</td>
                <td class="cell" id="44">0</td>
            </tr>
        </table>
    </body>
</html>
